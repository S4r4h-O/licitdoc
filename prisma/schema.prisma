generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ------------------- USUÁRIOS E EMPRESAS -------------------

model Company {
  id           String  @id @default(uuid()) @db.Uuid
  clerkOrgId   String? @unique
  razaoSocial  String  @unique @db.VarChar(150)
  nomeFantasia String  @db.VarChar(100)
  logo         String?
  cnpj         String  @unique @db.VarChar(18)
  email        String  @unique @db.VarChar(50)
  phone        String? @db.VarChar(20)

  addressStreet     String
  addressNumber     String
  addressComplement String?
  addressCountry    String
  addressCity       String
  addressState      String  @db.VarChar(2)
  addressZip        String  @db.VarChar(9)

  status CompanyStatus @default(ATIVA)
  plan   Plans?

  members              User[]
  documentRequirements DocumentRequirement[]
  licitacoes           Licitacao[]

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([plan])
  @@index([addressState])
  @@index([addressCity])
  @@index([addressCity, addressState])
}

enum CompanyStatus {
  ATIVA
  INATIVA
}

enum Plans {
  GRATUITO
  PRO
}

model User {
  id      String  @id @default(uuid()) @db.Uuid
  clerkId String  @unique
  email   String  @unique
  name    String?
  image   String?

  companyId String?  @db.Uuid
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  documentRequirements DocumentRequirement[]

  @@index([companyId])
}

// ------------------- ÓRGÃOS -------------------

model ContractingAuthority {
  id           String  @id @default(uuid()) @db.Uuid
  name         String  @db.VarChar(100)
  addressState String?
  addressCity  String?

  licitacoes Licitacao[]

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt
}

// ------------------- LICITAÇÕES -------------------

model Licitacao {
  id              String    @id @default(uuid()) @db.Uuid
  companyId       String    @db.Uuid
  contactorId     String    @db.Uuid
  licitacaoNumber String?   @db.VarChar(50)
  processNumber   String?
  buyer           String    @db.VarChar(100)
  openingDate     DateTime?

  requirements LicitacaoRequirement[]
  submissions  LicitacaoSubmission[]
  company      Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contractor   ContractingAuthority   @relation(fields: [contactorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([openingDate])
}

// ------------------- DOCUMENTOS E REQUISITOS -------------------

enum JurisdictionLevel {
  FEDERAL
  ESTADUAL
  MUNICIPAL
  OUTRO
}

enum DocumentStatus {
  VALIDO
  INVALIDO
}

model DocumentRequirement {
  id                String             @id @default(uuid()) @db.Uuid
  companyId         String             @db.Uuid
  userId            String             @db.Uuid
  name              String             @db.VarChar(100)
  jurisdictionLevel JurisdictionLevel?

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  documents  DocumentFile[]
  licitacoes LicitacaoRequirement[]

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
  @@index([companyId])
  @@index([userId])
}

model DocumentFile {
  id                    String @id @default(uuid()) @db.Uuid
  documentRequirementId String @db.Uuid

  fileName String
  fileUrl  String
  fileSize Int?

  issuingAuthority String?
  issueDate        DateTime?
  expirationDate   DateTime?
  documentNumber   String?

  status DocumentStatus @default(VALIDO)

  deletedAt DateTime?

  requirement DocumentRequirement   @relation(fields: [documentRequirementId], references: [id], onDelete: Cascade)
  submissions LicitacaoSubmission[]

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  @@index([documentRequirementId])
  @@index([status])
  @@index([expirationDate])
  @@index([deletedAt])
}

// ------------------- RELAÇÕES -------------------

model LicitacaoRequirement {
  id            String @id @default(uuid()) @db.Uuid
  licitacaoId   String @db.Uuid
  requirementId String @db.Uuid

  licitacao   Licitacao           @relation(fields: [licitacaoId], references: [id], onDelete: Cascade)
  requirement DocumentRequirement @relation(fields: [requirementId], references: [id])

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@unique([licitacaoId, requirementId])
  @@index([licitacaoId])
  @@index([requirementId])
}

model LicitacaoSubmission {
  id             String @id @default(uuid()) @db.Uuid
  licitacaoId    String @db.Uuid
  documentFileId String @db.Uuid

  licitacao    Licitacao    @relation(fields: [licitacaoId], references: [id], onDelete: Cascade)
  documentFile DocumentFile @relation(fields: [documentFileId], references: [id])

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@unique([licitacaoId, documentFileId])
  @@index([licitacaoId])
  @@index([documentFileId])
}
